{% extends "base.html" %}
{% block title %}Scoreboard{% endblock %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/echarts.min.js') }}"></script>
{% endblock %}
{% block content %}
<div class="container md-page">
    <div id="teamBar" style="width: 100%; height:400px;"></div>
    <hr>
    <div id="teamLine" style="width: 100%; height:400px;"></div>
    <script>
        // Bar chart for all teams
        var teamBarChart = echarts.init(document.getElementById('teamBar'));
        teamBarChart.showLoading();

        // Handle window resize to make charts responsive
        window.addEventListener('resize', function() {
            teamBarChart.resize();
        });

        function toInt(value) {
            return parseInt(value, 10) || 0;
        }

        function renderBarChart(data) {
            var slaEnabled = data.sla_enabled || false;
            var labels = data.labels || [];
            var serviceScores = (data.service_scores || []).map(toInt);
            var injectScores = (data.inject_scores || []).map(toInt);
            var adjustedScores = (data.adjusted_scores || []).map(toInt);
            var redFlagPenalties = (data.red_flag_penalties || []).map(function (value) {
                return -Math.abs(toInt(value));
            });
            var manualAdjustmentRaw = (data.manual_adjustments || []).map(toInt);
            var manualAdjustmentsPositive = manualAdjustmentRaw.map(function (value) {
                return value > 0 ? value : 0;
            });
            var manualAdjustmentsNegative = manualAdjustmentRaw.map(function (value) {
                return value < 0 ? value : 0;
            });
            var slaPenalties = (data.sla_penalties || []).map(function (value) {
                return -Math.abs(toInt(value));
            });

            var seriesData = [
                {
                    name: 'Services',
                    data: serviceScores,
                    type: 'bar',
                    stack: 'positive',
                },
                {
                    name: 'Injects',
                    data: injectScores,
                    type: 'bar',
                    stack: 'positive',
                },
                {
                    name: 'Manual Adjustments (+)',
                    data: manualAdjustmentsPositive,
                    type: 'bar',
                    stack: 'positive',
                    itemStyle: { color: '#2ca02c' }
                },
                {
                    name: 'Red Flag Penalties',
                    data: redFlagPenalties,
                    type: 'bar',
                    stack: 'negative',
                    itemStyle: { color: '#ff6f61' }
                },
                {
                    name: 'Manual Adjustments (-)',
                    data: manualAdjustmentsNegative,
                    type: 'bar',
                    stack: 'negative',
                    itemStyle: { color: '#ff9800' }
                }
            ];

            if (slaEnabled) {
                seriesData.push({
                    name: 'SLA Penalties',
                    data: slaPenalties,
                    type: 'bar',
                    stack: 'negative',
                    itemStyle: { color: '#c23531' }
                });
            }

            seriesData.push({
                name: 'Total Score',
                type: 'line',
                data: adjustedScores,
                symbol: 'circle',
                symbolSize: 8,
                lineStyle: { width: 2, color: '#00e5ff' },
                itemStyle: { color: '#00e5ff' },
                label: {
                    show: true,
                    position: 'top',
                    formatter: '{c}'
                }
            });

            var legendData = seriesData
                .filter(function (series) {
                    return series.name === 'Total Score' || (series.data || []).some(function (value) { return value !== 0; });
                })
                .map(function (series) { return series.name; });

            teamBarChart.hideLoading();
            teamBarChart.setOption({
                title: {
                    text: slaEnabled ? 'Total Scores (with Penalties and Adjustments)' : 'Total Scores',
                    x: 'center',
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        var result = params[0].name + '<br/>';
                        var total = 0;
                        var totalScore = adjustedScores[params[0].dataIndex] || 0;
                        params.forEach(function(item) {
                            var value = toInt(item.value);
                            if (item.seriesName !== 'Total Score') {
                                total += value;
                            }
                            if (value < 0) {
                                result += item.marker + item.seriesName + ': <span style=\"color:#ff6f61\">' + value + '</span><br/>';
                            } else {
                                result += item.marker + item.seriesName + ': ' + value + '<br/>';
                            }
                        });
                        result += '<strong>Total Score: ' + totalScore + '</strong>';
                        return result;
                    }
                },
                legend: {
                    data: legendData,
                    top: 30
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: [
                    {
                        type: 'category',
                        data: labels,
                    }
                ],
                yAxis: {
                    type: 'value'
                },
                series: seriesData
            });
        }

        $.getJSON('/api/scoreboard/get_bar_data')
            .done(function (data) {
                renderBarChart(data);
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                teamBarChart.hideLoading();
                console.error('Failed to load scoreboard data:', textStatus, errorThrown);
            });

        // Update chart every 30 seconds
        setInterval(function () {
            $.get('/api/scoreboard/get_bar_data').done(function (data) {
                renderBarChart(data);
            });
        }, 30000);
    </script>
    <script>
        // Line chart for all teams
        var teamLineChart = echarts.init(document.getElementById('teamLine'));
        teamLineChart.showLoading();

        // Handle window resize to make charts responsive
        window.addEventListener('resize', function() {
            teamLineChart.resize();
        });

        const seriesList = [];
        $.getJSON('/api/scoreboard/get_line_data')
            .done(function (data) {
                echarts.util.each(data.team, function (team) {
                    seriesList.push({
                        name: team.name,
                        type: 'line',
                        data: team.scores,
                        itemStyle: {
                            color: team.color
                        },
                        showSymbol: false
                    });
                });
                teamLineChart.hideLoading();
                teamLineChart.setOption({
                    title: {
                        text: 'Service Scores',
                        x: 'center',
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        boundaryGap: false,
                        data: data.rounds
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: seriesList,
                    // label: {
                    //     show: true
                    // },
                });
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                teamLineChart.hideLoading();
                console.error('Failed to load line chart data:', textStatus, errorThrown);
            });

        // Update chart every 30 seconds
        setInterval(function () {
            const seriesList = [];
            $.get('/api/scoreboard/get_line_data').done(function (data) {
                echarts.util.each(data.team, function (team) {
                    seriesList.push({
                        name: team.name,
                        type: 'line',
                        data: team.scores,
                    });
                });
                teamLineChart.setOption({
                    series: seriesList,
                });
            });
        }, 30000);
    </script>
</div>
{% endblock %}
