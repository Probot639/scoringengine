{% extends 'base.html' %}
{% block title %}Stats{% endblock %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/js/jquery.dataTables.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/dataTables.bootstrap.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/dataTables.bootstrap.min.css') }}" />
{% endblock %}
{% block content %}
<div class="container-fluid md-page">
    {% if current_user.is_white_team %}
    <div class="row">
        <h2 class="text-center">Add Flag</h2>
    </div>
    <div class="row" style="margin-bottom: 20px;">
        <div class="col-sm-8 col-sm-offset-1">
            <input id="add_flag_content" class="form-control" type="text" placeholder="Flag content">
        </div>
        <div class="col-sm-2">
            <button id="add_flag_button" class="btn btn-primary">Add Flag</button>
        </div>
    </div>
    <div class="row">
        <p id="add_flag_status" class="text-center"></p>
    </div>
    <div class="row">
        <h2 class="text-center">Manual Score Adjustment</h2>
    </div>
    <div class="row" style="margin-bottom: 20px;">
        <div class="col-sm-3 col-sm-offset-2">
            <select id="adjust_team_id" class="form-control">
                {% for team in teams %}
                <option value="{{ team.id }}">{{ team.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-sm-2">
            <input id="adjust_points" class="form-control" type="number" placeholder="+10 / -10">
        </div>
        <div class="col-sm-3">
            <input id="adjust_reason" class="form-control" type="text" placeholder="Reason (optional)">
        </div>
        <div class="col-sm-2">
            <button id="adjust_score_button" class="btn btn-warning">Apply</button>
        </div>
    </div>
    <div class="row">
        <p id="adjust_score_status" class="text-center"></p>
    </div>
    {% endif %}
    {% if current_user.is_red_team %}
    <div class="row">
        <h2 class="text-center">Submit Captured Flag</h2>
    </div>
    <div class="row" style="margin-bottom: 20px;">
        <div class="col-sm-3 col-sm-offset-3">
            <input id="submit_flag_content" class="form-control" type="text" placeholder="Flag content">
        </div>
        <div class="col-sm-3">
            <select id="submit_team_id" class="form-control">
                {% for team in teams %}
                <option value="{{ team.id }}">{{ team.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-sm-2">
            <button id="submit_flag_button" class="btn btn-danger">Submit Flag</button>
        </div>
    </div>
    <div class="row">
        <p id="submit_flag_status" class="text-center"></p>
    </div>
    {% endif %}
    <div class="row">
        {% if current_user.is_red_team %}
        <h2 class="text-center">Submitted Flags</h2>
        {% elif current_user.is_white_team %}
        <h2 class="text-center">Currently Deployed Flags</h2>
        {% else %}
        <h2 class="text-center">Active Flags</h2>
        {% endif %}
    </div>
    <div class="row">
        <table id="flags" class="table table-striped table-bordered table-compact" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Content</th>
                </tr>
            </thead>
        </table>
    </div>
    {% if current_user.is_white_team %}
    <div class="row">
        <h2 class="text-center">Capture Status for Active Flags</h2>
	<h5 class="text-center"><span class='glyphicon glyphicon-minus' style='color: gray'></span> means no capture; <span class='glyphicon glyphicon-user' style='color: blue'></span> means user level capture; and <span class='glyphicon glyphicon-fire' style='color: red'></span> means root level capture</h5>
    </div>
    <div class="row">
        <table id="solves" class="table table-striped table-bordered table-compact" cellspacing="0" width="100%">
            <thead>
                <tr>
                </tr>
            </thead>
        </table>
    </div>
    {% endif %}
    {% if current_user.is_red_team %}
    <div class="row">
        <h2 class="text-center">Competition Flag Capture Stats</h2>
	<h5 class="text-center">A lower score means the team is doing better</h5>
        <table id="totals" class="table table-striped table-bordered table-compact" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Team</th>
                    <th>Windows Score</th>
                    <th>nix Score</th>
                    <th>Total Score</th>
                </tr>
            </thead>
        </table>
    </div>
    {% endif %}
</div>
<script>
  var flagsTable = $('#flags').DataTable( {
      ajax: '/api/flags',
      order: [[0, 'asc']],
      columns: [
        { data: 'content' }
      ],
  } );
</script>
{% if current_user.is_white_team %}
<script>
  $('#add_flag_button').on('click', function() {
      var flagContent = $('#add_flag_content').val();
      if (!flagContent) {
          $('#add_flag_status').text('Content is required');
          return;
      }
      $.ajax({
          url: '/api/flags/add',
          type: 'POST',
          data: {
              content: flagContent
          },
          success: function(resp) {
              $('#add_flag_status').text('Flag added: ' + resp.flag_id);
              flagsTable.ajax.reload();
          },
          error: function(xhr) {
              var err = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : 'Add failed';
              $('#add_flag_status').text(err);
          }
      });
  });

  $('#adjust_score_button').on('click', function() {
      var teamId = $('#adjust_team_id').val();
      var points = $('#adjust_points').val();
      var reason = $('#adjust_reason').val();
      $('#adjust_score_status').text('');

      if (!points) {
          $('#adjust_score_status').text('Points are required');
          return;
      }

      $.ajax({
          url: '/api/flags/adjust_score',
          type: 'POST',
          data: {
              team_id: teamId,
              points: points,
              reason: reason
          },
          success: function(resp) {
              $('#adjust_score_status').text('Applied ' + resp.points + ' points to team ' + resp.team_id);
          },
          error: function(xhr) {
              var err = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : 'Adjustment failed';
              $('#adjust_score_status').text(err);
          }
      });
  });
</script>
{% endif %}
{% if current_user.is_white_team %}
<script>
$(document).ready(function() {
    $.ajax({
        url: '/api/flags/solves',  // API endpoint to fetch data
        success: function(response) {
            $('#solves').DataTable({
                data: response.data.rows, 
		scrollX: true,
                columns: response.data.columns.map(col => ({
		    title: col.replace("_BTA ", ""),
		    render: function (data, type, row) {
			// Render fire for true pwn, gray minus for false/no pwn
			if(typeof data === "string") {
			    return data;
			} else if (Array.isArray(data)) {
			    if(data[1] == 1) {
			        return "<span class='glyphicon glyphicon-fire' style='color: red'></span>";
			    } else if(data[0] == 1) {
			        return "<span class='glyphicon glyphicon-user' style='color: blue'></span>";
		            } else {
			        return "<span class='glyphicon glyphicon-minus' style='color: gray'></span>";
			    }
			}
                    }
		})), 
                ordering: false,  // Disable ordering on all columns
            });
        },
        error: function(xhr, status, error) {
            console.error('Error fetching data:', error);
        }
    });
});
</script>
{% endif %}
{% if current_user.is_red_team %}
<script>
  $('#totals').DataTable( {
      ajax: '/api/flags/totals',
      order: [[1, 'asc']],
      columns: [
        { data: 'team' },
        { data: 'win_score' },
        { data: 'nix_score' },
        { data: 'total_score' }
      ],
  } );
</script>
{% endif %}
{% if current_user.is_red_team %}
<script>
  $('#submit_flag_button').on('click', function() {
      var flagContent = $('#submit_flag_content').val();
      var teamId = $('#submit_team_id').val();
      $('#submit_flag_status').text('');

      if (!flagContent) {
          $('#submit_flag_status').text('Content is required');
          return;
      }

      $.ajax({
          url: '/api/flags/submit',
          type: 'POST',
          data: {
              content: flagContent,
              team_id: teamId
          },
          success: function(resp) {
              $('#submit_flag_status').text('Submitted. Deducted ' + resp.points_deducted + ' points.');
          },
          error: function(xhr) {
              var err = (xhr.responseJSON && xhr.responseJSON.error) ? xhr.responseJSON.error : 'Submission failed';
              $('#submit_flag_status').text(err);
          }
      });
  });
</script>
{% endif %}
{% endblock %}
